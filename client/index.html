<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Automatic Billing</title>

    <link rel="stylesheet" href="assets/client.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>

<body>
    <!-- "‚ûï Add New Product" Button -->
    <div class="container">
        <a href="add.html" class="btn btn-primary" style="margin: 20px;">‚ûï Add New Product</a>
    </div>

    <!--Animation-->
    <div class="lottie" id="1">
        <lottie-player src="https://assets1.lottiefiles.com/packages/lf20_jioazy9u.json" background="transparent"
            speed="1" loop autoplay></lottie-player>
        <div class="text">PLACE ITEMS TO START CHECKOUT</div>
    </div>

    <!--Main-->
    <main id="home"></main>

    <!--Checkout Button-->
    <div id="final">
        <button id="checkout-btn" class="checkout" onclick="checkout()">CHECKOUT</button>
    </div>

    <!--QR code-->
    <div id="qr" class="animated fadeInUp once" style="display: none;">
        Scan QR Code To Pay
        <img id="image" src="" />
    </div>

    <!--Success-->
    <div id="success" style="display: none;">
        <lottie-player src="https://assets7.lottiefiles.com/private_files/lf30_poez9ped.json" background="transparent"
            speed="1" style="width: 300px; height: 300px;" loop autoplay></lottie-player>
    </div>

    <!--API Data Update Listener-->
    <script>
        const BACKEND_URL = "https://autobill-server-2.onrender.com";
        const socket = io(BACKEND_URL);

        // ‚úÖ WebSocket Connection Status
        socket.on("connect", () => console.log("üü¢ WebSocket Connected"));
        socket.on("disconnect", () => console.log("üî¥ WebSocket Disconnected"));

        async function loadProducts() {
            try {
                let res = await axios.get(`${BACKEND_URL}/products`);
                let products = res.data;

                document.getElementById("home").innerHTML = products.map(product => `
                    <section>
                        <div class="card card-long animated fadeInUp">
                            <img src="assets/images/${product.id}.jpg" class="album"> 
                            <div class="span1">Product Name</div>
                            <div class="card__product">
                                <span>${product.name}</span>
                            </div>
                            <div class="span2">Per Unit</div>
                            <div class="card__price">
                                <span>${product.price}</span>
                            </div>
                            <div class="span3">Units</div>
                            <div class="card__unit">
                                <span>${product.taken} ${product.unit}</span>
                            </div>
                            <div class="span4">Payable</div>
                            <div class="card__amount">
                                <span>${product.payable}</span>
                            </div>
                        </div>
                    </section>
                `).join("");

                document.getElementById("checkout-btn").innerText = `CHECKOUT $${products.reduce((sum, p) => sum + parseFloat(p.payable), 0)}`;
            } catch (error) {
                console.error("‚ùå Failed to Load Products:", error);
            }
        }

        async function checkout() {
            document.getElementById("checkout-btn").innerHTML = "<span class='loader-16' style='margin-left: 44%;'></span>";

            try {
                let res = await axios.post(`${BACKEND_URL}/checkout`);
                let total = res.data.total;

                let qrURL = `https://api.scanova.io/v2/qrcode/text?data=upi%3A%2F%2Fpay%3Fpa%3Dshebinjosejacob2014%40oksbi%26pn%3DTXN965654954321%26tn%3DA%26am%3D${total}%26cu%3DINR&size=l`;
                let qrRes = await fetch(qrURL);
                let qrBlob = await qrRes.blob();
                document.getElementById("image").src = URL.createObjectURL(qrBlob);

                document.getElementById("home").style.display = "none";
                document.getElementById("qr").style.display = "grid";

                setTimeout(() => {
                    document.getElementById("qr").style.display = "none";
                    document.getElementById("success").style.display = "grid";
                }, 10000);
            } catch (error) {
                alert("‚ùå Checkout Failed!");
                console.error(error);
            }
        }

        // ‚úÖ Listen for Backend Product Updates & Auto-Reload UI
        socket.on("cart-update", () => {
            console.log("üîÑ Cart Update Triggered!");
            loadProducts();
        });

        // ‚úÖ Initial Load
        loadProducts();
    </script>
</body>

</html>